#!/usr/bin/env bash
# SPDX-License-Identifier: Apache-2.0
# Self-bootstrapping Gradle wrapper (lightweight) used because canonical gradle-wrapper.jar is not vendored.
# It reads distributionUrl from gradle/wrapper/gradle-wrapper.properties, downloads & caches the distro,
# then invokes its gradle launcher. If gradle-wrapper.jar is later added, that jar will take precedence.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROPS="$SCRIPT_DIR/gradle/wrapper/gradle-wrapper.properties"
WRAPPER_JAR="$SCRIPT_DIR/gradle/wrapper/gradle-wrapper.jar"

if [[ -f "$WRAPPER_JAR" ]]; then
	exec "${JAVA_HOME:-$(command -v java >/dev/null 2>&1 && echo java || true)}" -jar "$WRAPPER_JAR" "$@"
fi

if [[ ! -f "$PROPS" ]]; then
	echo "gradle-wrapper.properties not found: $PROPS" >&2
	exit 1
fi

DIST_URL_LINE=$(grep '^distributionUrl=' "$PROPS" || true)
DIST_URL=${DIST_URL_LINE#distributionUrl=}
# Unescape \: in properties (Gradle uses escaping in .properties)
DIST_URL=${DIST_URL//\\:/:}
if [[ -z "$DIST_URL" ]]; then
	echo "distributionUrl missing in $PROPS" >&2
	exit 1
fi

GRADLE_USER_HOME_DEFAULT="${GRADLE_USER_HOME:-$HOME/.gradle}"
DIST_DIR="$GRADLE_USER_HOME_DEFAULT/wrapper/dists"
mkdir -p "$DIST_DIR"
ARCHIVE_NAME="${DIST_URL##*/}"
BASE_NAME="${ARCHIVE_NAME%.zip}"
TARGET_DIR="$DIST_DIR/$BASE_NAME"
# Gradle wrapper adds a hash dir inside target dir; detect actual gradle dir
find_gradle_bin() {
	local root="$1"
	# Prefer hash subdir if exists
	local cand
	cand=$(find "$root" -maxdepth 3 -type f -path "*/gradle-*/bin/gradle" 2>/dev/null | head -n1 || true)
	if [[ -n $cand ]]; then echo "$cand"; return 0; fi
	echo "$root/gradle-$BASE_NAME/bin/gradle"
}
BIN_GRADLE=$(find_gradle_bin "$TARGET_DIR")

if [[ ! -x "$BIN_GRADLE" ]]; then
	TMP_ZIP="$DIST_DIR/$ARCHIVE_NAME"
	if [[ ! -f "$TMP_ZIP" ]]; then
		echo "Downloading Gradle distribution: $DIST_URL" >&2
		curl -fsSL "$DIST_URL" -o "$TMP_ZIP"
	fi
	echo "Extracting Gradle distribution to $TARGET_DIR" >&2
	mkdir -p "$TARGET_DIR"
	unzip -q -o "$TMP_ZIP" -d "$TARGET_DIR"
		BIN_GRADLE=$(find_gradle_bin "$TARGET_DIR")
		chmod +x "$BIN_GRADLE" 2>/dev/null || true
fi

exec "$BIN_GRADLE" "$@"
